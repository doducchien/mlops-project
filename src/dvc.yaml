flows:
  main_pipeline:
    name: Main Pipeline
    description: Full pipeline for MLOps including triggers, fine-tuning, and deployment.

    tasks:
      # Task 1: Kiểm tra thay đổi dữ liệu bằng DVC
      - name: check_data
        description: Check if data or models have changed using DVC.
        commands:
          - |
            if [[ $(dvc status) != "Data and pipelines are up to date." ]]; then
              echo "Data has changed. Proceeding to fine-tune."
              touch proceed_to_fine_tune  # Tạo trigger file nếu dữ liệu thay đổi
            else
              echo "No changes in data. Skipping fine-tune."
            fi

      # Task 2: Fine-Tune GPT-2 Model (chỉ chạy khi có trigger)
      - name: fine_tune_model
        description: Fine-tune GPT-2 model only if changes are detected.
        conditions:
          - exists: proceed_to_fine_tune  # Chỉ chạy nếu file trigger tồn tại
        commands:
          - python src/train_model.py
          - dvc add models/fine_tuned_gpt2/
          - git add models/fine_tuned_gpt2.dvc
          - git commit -m "Fine-tuned GPT-2 model updated with DVC"
          - git push origin main
          - dvc push

      # Task 3: Deploy Fine-Tuned Model API
      - name: deploy_api
        description: Build and deploy the fine-tuned GPT-2 model as an API using Docker.
        commands:
          - docker build -t gpt2-api .
          - docker run -d -p 8000:8000 gpt2-api

      # Task 4: Monitor Model Performance
      - name: monitor_model
        description: Monitor the deployed model and log performance metrics.
        commands:
          - python src/monitoring.py
